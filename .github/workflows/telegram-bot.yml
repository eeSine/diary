name: Telegram Diary Bot

on:
  repository_dispatch:
    types: [telegram-message]

jobs:
  process-diary:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Process diary entry
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      run: |
        # åˆ›å»ºå¤„ç†è„šæœ¬
        cat > process_diary.js << 'EOF'
        const fs = require('fs');
        const path = require('path');
        
        // ä»ç¯å¢ƒå˜é‡è·å–æ¶ˆæ¯æ•°æ®
        const payload = JSON.parse(process.env.GITHUB_EVENT_CLIENT_PAYLOAD || '{}');
        const text = payload.text || '';
        const chatId = payload.chat_id || '';
        
        console.log('Processing message:', text.substring(0, 100));
        
        // è§£ææ—¥è®°æ ¼å¼
        function parseDiaryEntry(text) {
            const lines = text.trim().split('\n');
            if (lines.length === 0) return null;
            
            const firstLine = lines[0].trim();
            const content = lines.slice(1).join('\n').trim();
            
            // æå–æ—¥æœŸå’Œæ ‡é¢˜
            const dateMatch = firstLine.match(/^(\d{4}-\d{2}-\d{2})\s+(.+)$/);
            if (!dateMatch) return null;
            
            const [, date, title] = dateMatch;
            return { date, title, content, firstLine };
        }
        
        // åˆ›å»ºå®‰å…¨çš„æ–‡ä»¶å
        function createSafeFileName(date, title) {
            const safeTitle = title
                .replace(/[<>:"/\\|?*]/g, '_')  // æ›¿æ¢ä¸å®‰å…¨å­—ç¬¦
                .replace(/\s+/g, '_')           // ç©ºæ ¼æ›¿æ¢ä¸ºä¸‹åˆ’çº¿
                .substring(0, 50);              // é™åˆ¶é•¿åº¦
            return `${date}_${safeTitle}.md`;
        }
        
        // ä¸»å¤„ç†é€»è¾‘
        async function processDiary() {
            const diary = parseDiaryEntry(text);
            if (!diary) {
                console.log('FORMAT_ERROR');
                return;
            }
            
            const { date, title, content, firstLine } = diary;
            const [year, month] = date.split('-').slice(0, 2);
            const monthDir = `diaries/${year}-${month}`;
            const fileName = createSafeFileName(date, title);
            const filePath = path.join(monthDir, fileName);
            
            console.log(`Processing diary for ${date}: ${title}`);
            console.log(`Target file: ${filePath}`);
            
            // åˆ›å»ºç›®å½•
            if (!fs.existsSync('diaries')) {
                fs.mkdirSync('diaries');
            }
            if (!fs.existsSync(monthDir)) {
                fs.mkdirSync(monthDir, { recursive: true });
            }
            
            // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç›¸åŒæ—¥æœŸå’Œæ ‡é¢˜çš„æ–‡ä»¶
            let isUpdate = false;
            if (fs.existsSync(monthDir)) {
                const existingFiles = fs.readdirSync(monthDir);
                const existingFile = existingFiles.find(file => {
                    if (!file.endsWith('.md')) return false;
                    
                    // ä»æ–‡ä»¶åæå–æ—¥æœŸå’Œæ ‡é¢˜
                    const baseName = file.replace('.md', '');
                    const parts = baseName.split('_');
                    const fileDate = parts[0];
                    const fileTitle = parts.slice(1).join('_');
                    
                    // æ¯”è¾ƒæ—¥æœŸå’Œæ ‡é¢˜
                    const currentSafeTitle = title
                        .replace(/[<>:"/\\|?*]/g, '_')
                        .replace(/\s+/g, '_')
                        .substring(0, 50);
                    
                    return fileDate === date && fileTitle === currentSafeTitle;
                });
                
                if (existingFile) {
                    console.log(`Found existing file: ${existingFile}`);
                    fs.unlinkSync(path.join(monthDir, existingFile));
                    isUpdate = true;
                }
            }
            
            // åˆ›å»ºmarkdownå†…å®¹
            const fullContent = `# ${title}

*${date}*

${content}`;
            
            // å†™å…¥æ–‡ä»¶
            fs.writeFileSync(filePath, fullContent, 'utf8');
            
            console.log(isUpdate ? 'UPDATED' : 'CREATED');
            console.log(`File saved successfully: ${filePath}`);
            
            // éªŒè¯æ–‡ä»¶æ˜¯å¦æ­£ç¡®å†™å…¥
            if (fs.existsSync(filePath)) {
                const savedContent = fs.readFileSync(filePath, 'utf8');
                console.log(`File size: ${savedContent.length} characters`);
            }
        }
        
        processDiary().catch(error => {
            console.error('Error processing diary:', error);
            console.log('ERROR');
        });
        EOF
        
        # è¿è¡Œå¤„ç†è„šæœ¬
        export GITHUB_EVENT_CLIENT_PAYLOAD='${{ toJson(github.event.client_payload) }}'
        node process_diary.js > result.txt 2>&1
        
        # æ˜¾ç¤ºç»“æœ
        echo "=== Process Result ==="
        cat result.txt
        echo "===================="
        
        # æå–æœ€åä¸€è¡Œä½œä¸ºç»“æœ
        RESULT=$(grep -E "^(FORMAT_ERROR|UPDATED|CREATED|ERROR)$" result.txt | tail -1)
        echo "RESULT=$RESULT" >> $GITHUB_ENV
        
        # æäº¤æ›´æ”¹
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        
        # æ·»åŠ æ‰€æœ‰æ›´æ”¹
        git add diaries/
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if ! git diff --cached --quiet; then
          COMMIT_MSG="ğŸ“ Add/Update diary entry - $(date '+%Y-%m-%d %H:%M:%S')"
          git commit -m "$COMMIT_MSG"
          git push
          echo "âœ… Changes committed and pushed successfully"
        else
          echo "â„¹ï¸  No changes to commit"
        fi
        
    - name: Send Telegram response
      if: always()
      run: |
        # æ ¹æ®ç»“æœå‘é€ä¸åŒçš„å“åº”æ¶ˆæ¯
        case "$RESULT" in
          "FORMAT_ERROR")
            MESSAGE="âŒ æ ¼å¼é”™è¯¯ï¼%0A%0Aè¯·ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š%0A%0A\`2025-08-25 æ ‡é¢˜\`%0Aæ—¥è®°å†…å®¹..."
            ;;
          "UPDATED")
            MESSAGE="âœ… æ—¥è®°å·²æ›´æ–°ï¼%0A%0Aå¯ä»¥åœ¨ç½‘ç«™ä¸ŠæŸ¥çœ‹æ›´æ–°åçš„å†…å®¹ã€‚"
            ;;
          "CREATED")
            MESSAGE="âœ… æ—¥è®°å·²æ·»åŠ ï¼%0A%0Aæ–°çš„æ—¥è®°å·²ä¿å­˜åˆ°GitHubä»“åº“ã€‚"
            ;;
          "ERROR")
            MESSAGE="âŒ å¤„ç†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•æˆ–æ£€æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚"
            ;;
          *)
            MESSAGE="âœ… å¤„ç†å®Œæˆï¼"
            ;;
        esac
        
        CHAT_ID='${{ github.event.client_payload.chat_id }}'
        TELEGRAM_TOKEN='${{ secrets.TELEGRAM_TOKEN }}'
        
        if [ -n "$CHAT_ID" ] && [ -n "$TELEGRAM_TOKEN" ]; then
          echo "Sending response to chat $CHAT_ID"
          
          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "chat_id=${CHAT_ID}&text=${MESSAGE}&parse_mode=Markdown")
          
          echo "Telegram API response: $RESPONSE"
        else
          echo "Missing CHAT_ID or TELEGRAM_TOKEN"
        fi
